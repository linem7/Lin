% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sem_perms.R
\name{sem_perms}
\alias{sem_perms}
\title{Run all permutations of an SEM (Latent, Observed, or Hybrid) in Mplus}
\usage{
sem_perms(
  data,
  latent_defs,
  roles = NULL,
  covariate = NULL,
  extra_var = NULL,
  exclusion = NULL,
  fix = NULL,
  analysis = "esti = ml;",
  structural_tpl,
  output = "stand;",
  out_dir = ".",
  parameters = NULL,
  indices = NULL,
  minimal_run = TRUE,
  max_run = 10,
  ...
)
}
\arguments{
\item{data}{A data.frame containing all manifest indicators and covariates.}

\item{latent_defs}{A named list or character vector of variable definitions.
The function automatically detects the type of definition:
\itemize{
  \item \strong{Observed Variable}: If the value matches a column name in `data`,
        it is automatically formatted as `"var;"` for Mplus.
  \item \strong{Latent/Complex}: If the value is Mplus syntax (e.g., "F1 BY x1-x3;"),
        it is passed as-is.
}
Example:
```r
list(
  # Latent definition
  "Stress" = "Stress BY s1 s2 s3;",
  # Observed definition (Auto-detected)
  "Age"    = "age_col"
)
```}

\item{roles}{Character vector of roles to permute (default `c("x","m","y")`).
These names act as placeholders in `structural_tpl` and column headers in the result.}

\item{covariate}{Character vector of covariate names included in every model
(default `NULL`).}

\item{extra_var}{Optional character vector of additional manifest variables to
include in the `USEVARIABLES` list but not in the permutation logic.}

\item{exclusion}{List of vectors: each vector lists variable names (keys from `latent_defs`)
that should not co-occur in the same model.}

\item{fix}{Named list: each element is a vector of variable names allowed
for a specific role slot (e.g. `list(x = c("Stress","Anxiety"))`).}

\item{analysis}{String passed to Mplus "ANALYSIS:" block (default `"esti = ml;"`).}

\item{structural_tpl}{User-supplied glue template for the "MODEL:" block. Use `{role_name}`
placeholders (e.g., `{x}`, `{m}`) which will be replaced by the keys
from `latent_defs`.}

\item{output}{String passed to Mplus "OUTPUT:" block (default `"stand;"`).}

\item{out_dir}{Directory in which to write `.inp` and `.out` files
(default `"./"`).}

\item{parameters}{Character vector of specific parameter labels (e.g., `"ind_eff"`)
whose p-values you wish to extract into the results table.}

\item{indices}{Character vector of additional fit indices to extract from Mplus
summaries (e.g., `c("AIC", "BIC", "LL")`). Standard indices
(ChiSq, df, CFI, TLI, RMSEA, SRMR) are extracted by default.}

\item{minimal_run}{Logical; if `TRUE`, only the first `max_run` permutations are
generated and executed, for a quick preview.}

\item{max_run}{Integer; maximum number of models to generate and run when
`minimal_run = TRUE`.}

\item{...}{Additional arguments (currently unused).}
}
\value{
A data.frame with the following columns:
\itemize{
  \item \code{Models}: Unique model identifier (based on variable combination).
  \item \code{<roles>}: Columns named after `roles` showing the variable assigned to each role.
  \item \code{Fit Indices}: Standard indices (\eqn{\chi^2}, df, CFI, TLI, RMSEA, SRMR) plus any specified in `indices`.
  \item \code{Parameters}: P-values for parameters specified in `parameters`.
  \item \code{Warning/Error}: "Yes"/"No" indicators for Mplus execution status.
}
}
\description{
Automatically generates Mplus ".inp" files for every permutation
              of specified variable roles, runs them, and returns a combined
              data.frame.

              This function supports:
              \itemize{
                \item \strong{Latent Variable Models}: Standard SEM with measurement models.
                \item \strong{Observed Variable Models}: Path analysis using raw data columns.
                \item \strong{Hybrid Models}: Mix of latent and observed variables.
                \item \strong{Complex Syntax}: RI-CLPM or models with constraints (e.g., `@1`, `@0`).
              }

              The output includes model structure, standard fit indices, user-requested
              indices, and specific parameter p-values.
}
\details{
-----------------------------------------------------------------------------


\itemize{
  \item \strong{Robust Variable Extraction}: The function uses a regex-based extractor to identify
        required columns for `USEVARIABLES`. It handles syntax like `x1@1`, `x1-x5`, or `x*`
        correctly by cleaning symbols before matching against `names(data)`.

  \item \strong{Template Syntax}: The \code{structural_tpl} uses glue syntax. Placeholders
        matching \code{roles} (e.g., \code{{x}}) are replaced by the \strong{names} (keys)
        of the `latent_defs` list.

  \item \strong{Result Integrity}: Results are matched to models using the internal filename
        ID found within the Mplus output to ensure strict data alignment.
}
}
\examples{
\dontrun{

# ==============================================================================
# Example 1: Latent Variable Mediation (Standard SEM)
# ==============================================================================
# 1. Define Measurement Models (Mplus Syntax)
latent_defs_sem <- list(
  "Stress"     = "Stress BY s1 s2 s3;",
  "Anxiety"    = "Anxiety BY a1 a2 a3;",
  "Depression" = "Depression BY d1 d2 d3;",
  "Burnout"    = "Burnout BY b1 b2 b3;"
)

# 2. Define Structural Template (Using placeholders)
sem_structure <- "
  {y} ON {m} (b);
  {m} ON {x} (a);
  {y} ON {x} (cp);
  MODEL CONSTRAINT:
  NEW(ind);
  ind = a*b;
"

# 3. Run Permutations
res_sem <- sem_perms(
  data = my_data,
  latent_defs = latent_defs_sem,
  roles = c("x", "m", "y"),
  structural_tpl = sem_structure,
  out_dir = "output_sem",
  parameters = c("ind") # Extract indirect effect p-value
)

# ==============================================================================
# Example 2: Observed Variable Mediation (Path Analysis)
# ==============================================================================
# 1. Define Variables (Direct Column Names)
# Note: You do NOT need to add semicolons ";" here. The function adds them automatically.
obs_defs <- list(
  "SES"       = "ses_score",    # Colname in data is 'ses_score'
  "Education" = "edu_years",    # Colname in data is 'edu_years'
  "Income"    = "inc_log",      # Colname in data is 'inc_log'
  "Health"    = "health_idx"    # Colname in data is 'health_idx'
)

# 2. Define Structural Template
# The structure logic is identical to SEM, but Mplus treats them as observed variables.
path_structure <- "
  {y} ON {m} (b);
  {m} ON {x} (a);
  {y} ON {x} (cp);

  MODEL CONSTRAINT:
  NEW(ind total);
  ind = a*b;
  total = ind + cp;
"

# 3. Run Permutations with Constraints
res_path <- sem_perms(
  data = my_data,
  latent_defs = obs_defs,
  roles = c("x", "m", "y"),
  structural_tpl = path_structure,
  # Example constraint: X must be SES or Education
  fix = list(x = c("SES", "Education")),
  out_dir = "output_path",
  parameters = c("ind", "total")
)
}
}
